<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªåŠ¨åŒ–ä¼˜åŒ– - å¤šå¤šAIä¼˜åŒ–å¸ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f7fa; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 30px; }
        .smart-card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .smart-button { background: linear-gradient(135deg, #E84D1A 0%, #FF6B35 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 500; }
        .smart-button:hover { opacity: 0.9; }
        .smart-button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* å¼€å…³æ ·å¼ */
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 26px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #E84D1A; }
        input:checked + .slider:before { transform: translateX(24px); }
        
        /* æ€»å¼€å…³ */
        .master-switch { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: linear-gradient(135deg, #E84D1A 0%, #FF6B35 100%); color: white; border-radius: 12px; margin-bottom: 30px; }
        .master-switch h2 { margin: 0; }
        .master-switch .description { margin-top: 8px; opacity: 0.9; font-size: 0.9em; }
        
        /* åŠŸèƒ½å¡ç‰‡ */
        .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .feature-card { padding: 20px; border: 2px solid #e0e0e0; border-radius: 12px; transition: all 0.3s; }
        .feature-card:hover { border-color: #E84D1A; box-shadow: 0 4px 12px rgba(232, 77, 26, 0.1); }
        .feature-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .feature-header h3 { margin: 0; color: #333; font-size: 1.1em; }
        .feature-description { color: #666; margin-bottom: 15px; font-size: 0.9em; }
        .feature-settings { background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .feature-settings label { display: block; margin-bottom: 10px; color: #666; }
        .feature-settings input { width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 4px; margin-left: 8px; }
        
        /* æ“ä½œæ—¥å¿— */
        .log-entry { display: grid; grid-template-columns: 40px 120px 1fr 150px 40px; gap: 15px; align-items: center; padding: 15px; border-bottom: 1px solid #e0e0e0; }
        .log-entry:last-child { border-bottom: none; }
        .log-icon { font-size: 1.5em; text-align: center; }
        .log-time { color: #999; font-size: 0.85em; }
        .log-action { color: #333; }
        .log-change { color: #666; font-size: 0.9em; }
        .log-status { text-align: center; font-size: 1.2em; }
        .log-status.executed { color: #4CAF50; }
        .log-status.failed { color: #f44336; }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state .icon { font-size: 4em; margin-bottom: 20px; }
        
        /* æ‰‹åŠ¨è§¦å‘æŒ‰é’® */
        .manual-trigger { text-align: center; padding: 30px; background: #f8f9fa; border-radius: 12px; }
        .manual-trigger .smart-button { padding: 15px 40px; font-size: 1.1em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš™ï¸ è‡ªåŠ¨åŒ–ä¼˜åŒ–</h1>
        
        <!-- æ€»å¼€å…³ -->
        <div class="master-switch">
            <div>
                <h2>è‡ªåŠ¨åŒ–ä¼˜åŒ–å¼•æ“</h2>
                <p class="description">å¼€å¯åï¼Œç³»ç»Ÿå°†æŒ‰ç…§æ‚¨çš„è®¾ç½®è‡ªåŠ¨ä¼˜åŒ–å¹¿å‘ŠæŠ•æ”¾</p>
            </div>
            <label class="switch">
                <input type="checkbox" id="auto-enabled" onchange="toggleAutomation()">
                <span class="slider"></span>
            </label>
        </div>
        
        <!-- åŠŸèƒ½å¼€å…³ -->
        <div class="features-grid">
            <div class="feature-card">
                <div class="feature-header">
                    <h3>ğŸ’° è‡ªåŠ¨è°ƒæ•´å‡ºä»·</h3>
                    <label class="switch">
                        <input type="checkbox" id="auto-bid" onchange="saveSettings()">
                        <span class="slider"></span>
                    </label>
                </div>
                <p class="feature-description">æ ¹æ®ROIè‡ªåŠ¨è°ƒæ•´å…³é”®è¯å‡ºä»·</p>
                <div class="feature-settings">
                    <label>æœ€é«˜CPCï¼šÂ¥<input type="number" id="max-cpc" value="5" step="0.1" min="0.5" max="20" onchange="saveSettings()"></label>
                    <label>æœ€ä½CPCï¼šÂ¥<input type="number" id="min-cpc" value="0.5" step="0.1" min="0.1" max="5" onchange="saveSettings()"></label>
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-header">
                    <h3>â¸ï¸ è‡ªåŠ¨æš‚åœä½æ•ˆå…³é”®è¯</h3>
                    <label class="switch">
                        <input type="checkbox" id="auto-keyword" onchange="saveSettings()">
                        <span class="slider"></span>
                    </label>
                </div>
                <p class="feature-description">è¿ç»­3å¤©ROIä½äºé˜ˆå€¼è‡ªåŠ¨æš‚åœ</p>
                <div class="feature-settings">
                    <label>ROIé˜ˆå€¼ï¼š<input type="number" id="roi-threshold" value="1.0" step="0.1" min="0.1" max="5" onchange="saveSettings()"></label>
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-header">
                    <h3>â° è‡ªåŠ¨ä¼˜åŒ–æŠ•æ”¾æ—¶æ®µ</h3>
                    <label class="switch">
                        <input type="checkbox" id="auto-schedule" onchange="saveSettings()">
                        <span class="slider"></span>
                    </label>
                </div>
                <p class="feature-description">è‡ªåŠ¨é›†ä¸­é¢„ç®—åœ¨é«˜è½¬åŒ–æ—¶æ®µ</p>
                <div class="feature-settings">
                    <p style="color: #999; font-size: 0.85em; margin: 0;">ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†æ24å°æ—¶è½¬åŒ–æ•°æ®ï¼Œé€‰æ‹©æœ€ä½³8ä¸ªæ—¶æ®µæŠ•æ”¾</p>
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-header">
                    <h3>ğŸ·ï¸ è‡ªåŠ¨è°ƒæ•´ä»·æ ¼</h3>
                    <label class="switch">
                        <input type="checkbox" id="auto-price" onchange="saveSettings()">
                        <span class="slider"></span>
                    </label>
                </div>
                <p class="feature-description">æ ¹æ®å¸‚åœºå˜åŒ–è‡ªåŠ¨è°ƒæ•´äº§å“ä»·æ ¼</p>
                <div class="feature-settings">
                    <label>è°ƒä»·å¹…åº¦é™åˆ¶ï¼šÂ±<input type="number" id="price-limit" value="10" step="1" min="1" max="30" onchange="saveSettings()">%</label>
                </div>
            </div>
        </div>
        
        <!-- æ‰‹åŠ¨è§¦å‘ -->
        <div class="smart-card manual-trigger">
            <button onclick="runOptimization()" class="smart-button" id="run-btn">
                ğŸš€ ç«‹å³è¿è¡Œä¸€è½®ä¼˜åŒ–
            </button>
            <p style="color: #666; margin-top: 15px; font-size: 0.9em;">æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡ä¼˜åŒ–ï¼ŒæŸ¥çœ‹æ•ˆæœ</p>
        </div>
        
        <!-- æ“ä½œæ—¥å¿— -->
        <div class="smart-card">
            <h2 style="margin-bottom: 20px;">ğŸ“‹ æ“ä½œæ—¥å¿—</h2>
            <div id="log-list">
                <div class="empty-state">
                    <div class="icon">ğŸ“‹</div>
                    <p>è¿˜æ²¡æœ‰æ“ä½œè®°å½•</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentUser = { id: '1' };
        
        // é¡µé¢åŠ è½½æ—¶åŠ è½½è®¾ç½®å’Œæ—¥å¿—
        window.addEventListener('load', function() {
            loadSettings();
            loadLogs();
        });
        
        // åŠ è½½è®¾ç½®
        async function loadSettings() {
            try {
                const response = await fetch(`/api/automation/settings/${currentUser.id}`);
                const data = await response.json();
                
                if (data.success) {
                    const s = data.data;
                    document.getElementById('auto-enabled').checked = s.enabled;
                    document.getElementById('auto-bid').checked = s.auto_bid_adjust;
                    document.getElementById('auto-keyword').checked = s.auto_keyword_pause;
                    document.getElementById('auto-schedule').checked = s.auto_schedule;
                    document.getElementById('auto-price').checked = s.auto_price;
                    document.getElementById('max-cpc').value = s.max_cpc;
                    document.getElementById('min-cpc').value = s.min_cpc;
                    document.getElementById('roi-threshold').value = s.roi_threshold;
                    document.getElementById('price-limit').value = s.price_change_limit;
                }
            } catch (error) {
                console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
            }
        }
        
        // åˆ‡æ¢æ€»å¼€å…³
        async function toggleAutomation() {
            await saveSettings();
            const enabled = document.getElementById('auto-enabled').checked;
            
            if (enabled) {
                alert('âœ… è‡ªåŠ¨åŒ–å·²å¯ç”¨ï¼ç³»ç»Ÿå°†æŒ‰ç…§æ‚¨çš„è®¾ç½®è‡ªåŠ¨ä¼˜åŒ–ã€‚');
            } else {
                alert('â¸ï¸ è‡ªåŠ¨åŒ–å·²æš‚åœã€‚');
            }
        }
        
        // ä¿å­˜è®¾ç½®
        async function saveSettings() {
            const settings = {
                enabled: document.getElementById('auto-enabled').checked,
                auto_bid_adjust: document.getElementById('auto-bid').checked,
                auto_keyword_pause: document.getElementById('auto-keyword').checked,
                auto_schedule: document.getElementById('auto-schedule').checked,
                auto_price: document.getElementById('auto-price').checked,
                max_cpc: parseFloat(document.getElementById('max-cpc').value),
                min_cpc: parseFloat(document.getElementById('min-cpc').value),
                roi_threshold: parseFloat(document.getElementById('roi-threshold').value),
                price_change_limit: parseFloat(document.getElementById('price-limit').value)
            };
            
            try {
                const response = await fetch('/api/automation/configure', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        settings: settings
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    alert('ä¿å­˜å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        // è¿è¡Œä¼˜åŒ–
        async function runOptimization() {
            const btn = document.getElementById('run-btn');
            btn.disabled = true;
            btn.textContent = 'â³ ä¼˜åŒ–ä¸­...';
            
            try {
                const response = await fetch('/api/automation/run', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: currentUser.id })
                });
                
                const data = await response.json();
                
                btn.disabled = false;
                btn.textContent = 'ğŸš€ ç«‹å³è¿è¡Œä¸€è½®ä¼˜åŒ–';
                
                if (data.success) {
                    if (data.data.status === 'disabled') {
                        alert('âš ï¸ è¯·å…ˆå¯ç”¨è‡ªåŠ¨åŒ–ä¼˜åŒ–ï¼');
                    } else {
                        alert(`âœ… ä¼˜åŒ–å®Œæˆï¼æ‰§è¡Œäº† ${data.data.actions_count} ä¸ªæ“ä½œ`);
                        loadLogs();
                    }
                } else {
                    alert('âŒ ä¼˜åŒ–å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                btn.disabled = false;
                btn.textContent = 'ğŸš€ ç«‹å³è¿è¡Œä¸€è½®ä¼˜åŒ–';
                alert('âŒ ä¼˜åŒ–å¤±è´¥: ' + error.message);
            }
        }
        
        // åŠ è½½æ—¥å¿—
        async function loadLogs() {
            try {
                const response = await fetch(`/api/automation/logs/${currentUser.id}?limit=50`);
                const data = await response.json();
                
                if (data.success) {
                    renderLogs(data.data);
                }
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
            }
        }
        
        // æ¸²æŸ“æ—¥å¿—
        function renderLogs(logs) {
            const icons = {
                'adjust_bid': 'ğŸ’°',
                'pause_keyword': 'â¸ï¸',
                'adjust_schedule': 'â°',
                'adjust_price': 'ğŸ·ï¸'
            };
            
            if (logs.length === 0) {
                document.getElementById('log-list').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ“‹</div>
                        <p>è¿˜æ²¡æœ‰æ“ä½œè®°å½•</p>
                    </div>
                `;
                return;
            }
            
            const html = logs.map(log => {
                const details = log.details;
                const changeText = typeof details.old_value === 'object' 
                    ? `æ—¶æ®µè°ƒæ•´` 
                    : `${details.old_value} â†’ ${details.new_value}`;
                
                return `
                    <div class="log-entry">
                        <span class="log-icon">${icons[log.action_type] || 'âš™ï¸'}</span>
                        <span class="log-time">${formatTime(log.timestamp)}</span>
                        <span class="log-action">${details.reason}</span>
                        <span class="log-change">${changeText}</span>
                        <span class="log-status ${log.result}">${log.result === 'executed' ? 'âœ…' : 'âŒ'}</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('log-list').innerHTML = html;
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) {
                return 'åˆšåˆš';
            } else if (diff < 3600000) {
                return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            } else if (diff < 86400000) {
                return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            } else {
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            }
        }
    </script>
</body>
</html>
